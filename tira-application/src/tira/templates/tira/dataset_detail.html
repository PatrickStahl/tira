{% extends 'tira/base.html' %}
{% load static %}
{% block title %}TIRA Users{% endblock %}
{% block description %}TIRA Users{% endblock %}
{% block navbar %}{% include "tira/navbar.html" with nav_active='dataset' %}{% endblock %}

{% block content %}
<nav class="uk-container">
    <ul class="uk-breadcrumb">
        <li><a href="{% url 'tira:index' %}">Tira.io</a></li>
        <li><a href="{% url 'tira:task-detail' task_id=task.task_id %}">{{ task.task_name }}</a></li>
        <li class="uk-disabled"><a href="#">{{ dataset_id }}</a></li>
    </ul>
</nav>

<main class="uk-section uk-section-default">
    <div class="uk-container">
        <h1>{{ task.task_name }}</h1>
        <h2>Dataset: <span class="uk-text-muted">{{ dataset_id }}</span></h2>
    </div>

    <!--    <div class="uk-container uk-margin-medium">-->
    <!--        <ul class="uk-list">-->
    <!--            <li><span data-uk-icon="chevron-down"></span> <a href="#tira-evaluation-results">Evaluation Results</a></li>-->
    <!--            <li><span data-uk-icon="chevron-down"></span> <a href="#tira-runs">Runs</a></li>-->
    <!--        </ul>-->
    <!--    </div>-->

    <div class="uk-container uk-margin-medium">
        <table class="uk-margin-medium uk-table uk-table-divider uk-table-small sortable targetable">
            <thead>
            <tr>
                <th id="tira-evaluation-results"></th>
                {% if role == 'admin' %}
                <th colspan="{{ ev_keys|length|add:'3' }}">
                    {% else %}
                <th colspan="{{ ev_keys|length|add:'3' }}">
                    {% endif %}
                    Results of {{ dataset_id }}
                    <a href="#" class="uk-float-right uk-link-reset" data-uk-icon="chevron-up"></a>
                </th>
            </tr>
            <tr>
                <th></th>
                <th class="header"><span>Virtual Machine</span></th>
                {% if role == 'admin' %}
                <th class="header"><span>Actions</span></th>
                {% endif %}
                <th class="header"><span>Run</span></th>
                {% for key in ev_keys %}
                <th class="header"><span>{{ key }}</span></th>
                {% endfor %}
            </tr>
            </thead>
            <tbody>
            {% for eval in evaluations %}
            <tr>
                <td id="{{ dataset_id }}-{{ eval.vm_id }}-{{ eval.run_id }}"></td>
                <td>{{ eval.vm_id }}</td>
                {% if role == 'admin' %}
                <td>[<a href="{% url 'tira:software-detail' task_id=task.task_id vm_id=eval.vm_id %}">manage</a>]</td>
                {% endif %}
                {% if role == 'admin' %}
                <td><a href="#run-{{ eval.vm_id }}-{{ eval.run_id }}">{{ eval.run_id }}</a></td>
                {% else %}
                <td>{{ eval.run_id }}</td>
                {% endif %}
                {% for measure in eval.measures %}
                <td class="uk-text-truncate">{{ measure }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Run results - TODO only show when user is reviewer  -->
    {% if role == 'admin' %}
    <div class="uk-container uk-margin-medium">
        <h2 id="tira-runs">Runs</h2>
        <ul id="tira-run-accordion" class="uk-list uk-list-collapse uk-list-striped" uk-accordion="multiple: true">
            {% for vm in vms %}
            <li>
                <div class="uk-accordion-title uk-grid-collapse" data-uk-grid>
                    <div>
                        <table class="uk-text-small uk-width-5-6">
                            <tr>
                                <td class="uk-width-1-5 uk-text-left"><b>{{ vm.vm_id }}</b></td>
                                <td class="uk-width-1-5 uk-text-right">{{ vm.runs|length }} Runs</td>
                                <td class="uk-width-1-5 uk-text-right {% if vm.unreviewed_count > 0 %}uk-text-warning{% endif %}">
                                    {{ vm.unreviewed_count }} Unreviewed</td>
                                <td class="uk-width-1-5 uk-text-right">{{ vm.blinded_count }} Blinded</td>
                                <td class="uk-width-1-5 uk-text-right {% if vm.published_count == 0 %}uk-text-warning{% endif %}">
                                    {{ vm.published_count }} Published</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="uk-accordion-content uk-margin-remove-top">
                    <a href="{% url 'tira:software-detail' task_id=task.task_id vm_id=vm.vm_id %}">
                        [manage user]
                    </a>
                    <table class="uk-margin-remove-top uk-table uk-table-divider uk-table-small sortable">
                        <thead>
                        <tr>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th class="header"><span>Software</span></th>
                            <th class="header"><span>Actions</span></th>
                            <th class="header"><span>Run</span></th>
                            <th class="header"><span>Input Run</span></th>
                            <th class="header">Reviewer</th>
                            <th class="header">Review</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for run in vm.runs %}
                        <tr>
                            <td class="uk-table-shrink">
                                {% if run.review.noErrors == True %}
                                <div uk-tooltip="This run is OK">
                                    <i class="fas fa-check dataset-detail-icon uk-text-success"></i>
                                </div>
                                {% elif run.review.hasErrors == True %}
                                <div uk-tooltip="This run has errors">
                                    <i class="fas fa-times dataset-detail-icon uk-text-danger"></i>
                                </div>
                                {% endif %}
                            </td>
                            <td class="uk-table-shrink">
                                {% if run.review.blinded == True %}
                                <div uk-tooltip="This run is blinded">
                                    <i class="fas fa-user-slash dataset-detail-icon"></i>
                                </div>
                                {% else %}
                                <div uk-tooltip="This run is visible to the participant">
                                    <i class="fas fa-user dataset-detail-icon uk-text-success"></i>
                                </div>
                                {% endif %}
                            </td>
                            <td class="uk-table-shrink"> <!-- Icons -->
                                {% if run.review.published == True %}
                                <div uk-tooltip="This run is on the leaderbords">
                                    <i class="fas fa-users dataset-detail-icon uk-text-success"></i>
                                </div>
                                {% else %}
                                <div uk-tooltip="This run is not published">
                                    <i class="fas fa-users-slash dataset-detail-icon"></i>
                                </div>
                                {% endif %}
                            </td> <!-- id? -->
                            <td>{{ run.run.software }}</td>
                            <td>
                                [<a href="{% url 'tira:review' task_id=task.task_id vm_id=vm.vm_id dataset_id=dataset_id run_id=run.run.run_id %}">review</a>]
                            </td>
                            <td id="run-{{ vm.vm_id }}-{{ run.run.run_id }}">{{ run.run.run_id }}</td>
                            {% if run.run.input_run_id != 'none' %}
                            <td><a href="#run-{{ vm.vm_id }}-{{ run.run.input_run_id }}">{{ run.run.input_run_id }}</a>
                            </td>
                            {% else %}
                            <td>{{ run.run.input_run_id }}</td>
                            {% endif %}
                            <td>{{ run.review.reviewer }}</td>
                            <td>
                                {% if run.review.noErrors == True %}
                                This run is OK
                                {% elif run.review.hasErrorOutput == True %}
                                Output Error
                                {% elif run.review.otherErrors == True %}
                                Software Error
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

</main>

{% if not include_navigation %}
<script src="https://assets.webis.de/js/thirdparty/jquery/jquery.slim.min.js"></script>
{% endif %}
<script src="https://assets.webis.de/js/thirdparty/fontawesome/fontawesome.min.js"></script>
<script src="https://assets.webis.de/js/thirdparty/fontawesome/solid.min.js"></script>
<script src="https://assets.webis.de/js/filter.js"></script>
<script src="https://assets.webis.de/js/selection.js"></script>
<script src="https://assets.webis.de/js/tables.js"></script>
<script>initWebisTableFiltering();</script>
<script>initTableSorting();</script>

{% endblock %}