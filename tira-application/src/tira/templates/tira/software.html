{% extends 'tira/base.html' %}
{% load static %}
{% block title %}TIRA - My Software{% endblock %}
{% block description %}TIRA - My Software{% endblock %}
{% block navbar %}{% include "tira/navbar.html" with nav_active='software' %}{% endblock %}

{% block content %}

<nav class="uk-container">
<ul class="uk-breadcrumb">
<li><a href="{% url 'tira:index' %}">Tira.io</a></li>
<li><a href="{% url 'tira:task-detail' task_id=task.task_id%}">{{ task.task_name }}</a></li>
<li class="uk-disabled"><a href="#">{{ vm_id }}</a></li>
</ul>
</nav>

<main class="uk-section uk-section-default">
    <div class="uk-container">
        <h1>Virtual Machine &mdash; <span class="uk-text-muted">{{ vm_id }}</span></h1>
    </div>
    {% if vm_id == 'no-vm-assigned' %}
     <div class="uk-container uk-margin-medium">
        <div class="uk-grid-small uk-grid-match" uk-grid>
            <div class="uk-card uk-card-body uk-card-default">
                <b>No Virtual Machine.</b>
                Your TIRA account is currently not associated with a virtual machine. Please contact us to obtain one.
            </div>
        </div>
     </div>
    {% else %}
    <!-- VM State and general options   -->
    <div class="uk-container uk-margin-medium">
        <div class="uk-grid-small uk-grid-match" uk-grid>
            <div class="uk-card uk-card-small uk-card-body uk-card-default uk-width-1-2">
                <table>
                    <tr>
                        <td>Host</td><td id="vm_info_host">{{ responseVmInfo.host }}</td>
                    </tr>
                    <tr><td>&nbsp;</td></tr>
                    <tr>
                        <td>OS</td><td  id="vm_info_guestOs">{{ responseVmInfo.guestOs }}</td>
                    </tr>
                    <tr>
                        <td>RAM</td><td id="vm_info_memorySize">{{ responseVmInfo.memorySize }}</td>
                    </tr>
                    <tr>
                        <td>CPU</td><td id="vm_info_numberOfCpus">{{ responseVmInfo.numberOfCpus }}</td>
                    </tr>
                </table>
            </div>
            <div class="uk-card uk-card-small uk-card-body uk-card-default uk-width-1-4">
                <table class="">
<!--                    sandboxed -->
<!--                    running -->
                    <tr>
                        <td>State</td>
                        <td class="uk-label uk-label-success">running</td>
                    </tr>
                    <tr><td>&nbsp;</td></tr>
                    <tr>
                        <td class="uk-table-shrink uk-text-nowrap uk-table-middle">
                            SSH <span class="uk-text-lead uk-text-small">port {{ responseVmInfo.ssh_port }}</span>&nbsp;&nbsp;
                        </td>
<!--                        <td id="vm_info_ssh_port">{{ responseVmInfo.ssh_port }}</td>-->
                        <td>
                            {% if responseVmInfo.ssh_status %}
                            <div class="uk-label uk-label-success">open</div>
                            {% else %}
                            <div class="uk-label uk-label-danger">closed</div>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="uk-table-shrink uk-text-nowrap uk-table-middle">
                            RDP <span class="uk-text-lead uk-text-small">port {{ responseVmInfo.rdp_port }}</span>&nbsp;&nbsp;
                        </td>
<!--                        <td id="vm_info_rdp_port">{{ responseVmInfo.rdp_port }}</td>-->
                        <td>
                            {% if responseVmInfo.rdp_status %}
                            <div class="uk-label uk-label-success">open</div>
                            {% else %}
                            <div class="uk-label uk-label-danger">closed</div>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
            <div class="uk-width-1-4">
                    <div id="vm_power_button">
                        {% if responseVmInfo.is_running %}
                        <button class="uk-button uk-button-primary uk-text-center uk-button-danger uk-width-1-1">Shut Down</button>
                        {% else %}
                        <button class="uk-button uk-button-primary uk-text-center uk-width-1-1">Power On</button>
                        {% endif %}
                    </div>
                    <div>
                        <button class="uk-button uk-button-disabled uk-text-center uk-width-1-1" disabled>Stop VM</button>
                    </div>
                    <div>
                        <button class="uk-button uk-button-disabled uk-text-center uk-width-1-1" disabled>Abort Run</button>
                    </div>
                </div>
        </div>
    </div>

    <div class="uk-container uk-margin-small">
        <h2>Software</h2>

<!-- {id, count, command, working_directory, dataset, run, creation_date, last_edit} -->
        <ul uk-tab>
            {% for sw in software %}
            <li><a href="#">{{ sw.software.id }}</a></li>
<!--         show status as icon   -->
            {% endfor %}
            <li>
                <a href="#">Add Software<span class="uk-margin-small-left" uk-icon="icon: triangle-down"></span></a>
                <div uk-dropdown="mode: click">
                    <ul class="uk-nav uk-dropdown-nav">
                        <li><a href="#">Software</a></li>
<!--                        <li><a href="#">Advanced Software</a></li>-->
                        <li><a href="#">Result Upload</a></li>
                    </ul>
                </div>
            </li>
        </ul>
        <ul class="uk-switcher uk-margin">
            {% for sw in software %}
            <li>
                <form>
                    <div class="uk-grid-medium uk-margin-small uk-child-width-1-2" uk-grid>
                        <div>
                            <label class="uk-form-label" for="software-1-command-input">Command</label>
                            <div class="uk-form-controls">
                                <input class="uk-input" id="software-1-command-input" type="text"
                                       value="{{ sw.software.command }}" placeholder="Dummy Command">
                            </div>
                        </div>
                        <div>
                            <label class="uk-form-label" for="software-1-working-dir">Working Directory</label>
                            <div class="uk-form-controls">
                                <input class="uk-input" id="software-1-working-dir" type="text"
                                       value="{{ sw.software.working_directory }}" placeholder="/home/{{ user_id }}/">
                            </div>
                        </div>
                    </div>
                    <div class="uk-grid-medium uk-margin-small uk-child-width-1-2" uk-grid>
                        <div>
                            <label class="uk-form-label" for="software-1-input-dataset">Input Dataset</label>
                            <div class="uk-form-controls">

                                <select class="uk-select" id="software-1-input-dataset">
                                    <option value="None">None</option>
                                    <option value="{{ sw.software.dataset }}" selected>{{ sw.software.dataset }}</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="uk-form-label" for="software-1-input-run">Input Run</label>
                            <div class="uk-form-controls">
                                <select class="uk-select" id="software-1-input-run">
                                    <option>None</option>
                                    {% for run in sw.runs %}
                                        <option>{{ run.run_id }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
                <div>
                    <a class="uk-button uk-button-small uk-button-primary uk-width-1-6">run</a>
                    <a class="uk-button uk-button-small uk-button-default uk-width-1-6">save</a>
                    <div class="uk-align-right">
<!--                        <div class="uk-text-small uk-text-lead">created: {{ sw.software.creation_date }}</div>-->
                        <div class="uk-text-small uk-text-lead">last edit: {{ sw.software.last_edit }}</div>
                    </div>
                </div>
                <table class="uk-margin-medium uk-table uk-table-divider uk-table-small uk-table-responsive targetable">
                        <thead>
                        <tr>
                            <th></th>
                            <th class="uk-table-shrink"></th>
                            <th class="uk-table-shrink"></th>
                            <th class="uk-table-shrink"></th>
                            <th class="header uk-table-shrink uk-text-nowrap"><span>Run</span></th>
                            <th class="header uk-table-shrink uk-text-nowrap"><span>Input Run</span></th>
                            <th class="header"><span>Dataset</span></th>
                            <th class="header uk-text-center">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for run in sw.runs %}
                        <tr>
                            <td id="{{ vm_id }}-{{ sw.software.id }}-{{ run.run_id }}"></td>
                            <td class="uk-table-shrink">
                                {% if run.review.noErrors == True %}
                                <div uk-tooltip="This run is OK">
                                    <i class="fas fa-check dataset-detail-icon uk-text-success"></i>
                                </div>
                                {% elif run.review.hasErrors == True %}
                                <div uk-tooltip="This run has errors">
                                    <i class="fas fa-times dataset-detail-icon uk-text-danger"></i>
                                </div>
                                {% endif %}
                            </td>
                            <td class="uk-table-shrink">
                                {% if run.review.blinded == True %}
                                <div uk-tooltip="This run is blinded">
                                    <i class="fas fa-user-slash dataset-detail-icon"></i>
                                </div>
                                {% else %}
                                <div uk-tooltip="You can inspect the results of this run.">
                                    <i class="fas fa-user dataset-detail-icon uk-text-success"></i>
                                </div>
                                {% endif %}
                            </td>
                            <td class="uk-table-shrink"> <!-- Icons -->
                                {% if run.review.published == True %}
                                <div uk-tooltip="This run is on the leaderboards">
                                    <i class="fas fa-users dataset-detail-icon uk-text-success"></i>
                                </div>
                                {% else %}
                                <div uk-tooltip="This run is not published">
                                    <i class="fas fa-users-slash dataset-detail-icon"></i>
                                </div>
                                {% endif %}
                            </td>
                            <td class="uk-table-shrink uk-text-nowrap">
                                {% if run.input_run_id != "none" %}<i class="fas fa-level-up-alt fa-flip-horizontal"></i>{% endif %}
                                &nbsp;{{ run.run_id }}</td>
                            <td class="uk-table-shrink uk-text-nowrap">
                                {% if run.input_run_id != "none" %}{{ run.input_run_id }}{% endif %}
                            </td>
                            <td>{{ run.dataset }}</td>
                            <td class="uk-align-right uk-margin-remove">
                                {% if run.input_run_id == "none" %}
                                <a class="uk-button uk-button-small uk-button-default">evaluate</a>
                                {% endif %}
                                <a class="uk-button uk-button-small uk-button-default" href="{% url 'tira:review' task_id=task.task_id vm_id=vm_id dataset_id=sw.software.dataset run_id=run.run_id %}">inspect</a>
                                <a class="uk-button uk-button-small uk-button-danger">delete</a>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</main>

<script>
$(document).ready(function () {
    url = "/user/nik-111-u18/vm/nik-111-u18-04-tira-ubuntu-18-04-desktop-64bit/vm_info";
    (function (url) {
        $.getJSON(url, {})
            .done(function (data) {
                console.log(data);
            });
    })();
});
</script>

{% if not include_navigation %}
<script src="https://assets.webis.de/js/thirdparty/jquery/jquery.slim.min.js"></script>
{% endif %}
<script src="https://assets.webis.de/js/thirdparty/fontawesome/fontawesome.min.js"></script>
<script src="https://assets.webis.de/js/thirdparty/fontawesome/solid.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://assets.webis.de/js/filter.js"></script>
<script src="https://assets.webis.de/js/selection.js"></script>
<script src="https://assets.webis.de/js/tables.js"></script>
<script>initWebisTableFiltering();</script>
<script>initTableSorting();</script>
<script src="{% static 'tira/js/software.js' %}"></script>
<script>
    addSoftwareEvents("{{ user_id }}", "{{ vm_id }}")
</script>

{% endblock %}
